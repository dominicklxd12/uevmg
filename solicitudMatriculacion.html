<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Solicitudes de Matriculación</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="shortcut icon" href="unidad-educativa-logo.png" />
    <style>
        .solicitudes-tabs {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .solicitudes-tab-btn {
            background: #2f5597;
            color: #fff;
            border: none;
            border-radius: 8px 8px 0 0;
            padding: 0.8rem 2.5rem;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            outline: none;
        }
        .solicitudes-tab-btn.active, .solicitudes-tab-btn:hover {
            background: #548235;
            color: #fff;
        }
        .solicitudes-filtros {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        .solicitudes-filtros input, .solicitudes-filtros select {
            border-radius: 6px;
            border: 1px solid #ccc;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            min-width: 180px;
        }
        .solicitudes-filtros button {
            border-radius: 6px;
            border: none;
            padding: 0.5rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            background: #2f5597;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }
        .solicitudes-filtros button:hover {
            background: #548235;
        }
        .solicitudes-table-container {
            max-width: 1200px;
            margin: 0 auto 3rem auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(44,130,201,0.08);
            padding: 2rem 1rem;
        }
        .solicitudes-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1rem;
            border-radius: 8px;
            overflow: hidden;
        }
        .solicitudes-table th, .solicitudes-table td {
            padding: 12px 8px;
            border: 1px solid #e0e0e0;
            text-align: left;
        }
        .solicitudes-table th {
            background: #2f5597;
            color: #fff;
            font-size: 1rem;
            font-weight: bold;
        }
        .solicitudes-table tbody tr:nth-child(even) {
            background: #f7fafd;
        }
        .solicitudes-table tbody tr:hover {
            background: #eaf6ea;
        }
        .verificar-btn {
            background: #548235;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1.2rem;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .verificar-btn:hover {
            background: #2f5597;
        }
        .eliminar-btn {
            background: #d9534f;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1.2rem;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .eliminar-btn:hover {
            background: #c9302c;
        }
        .pdf-link {
            color: #2f5597;
            font-weight: bold;
            text-decoration: underline;
        }
        .pdf-link:hover {
            color: #548235;
        }
        .estado-label {
            font-weight: bold;
            color: #548235;
        }
        .detalle-btn {
            background: #2f5597;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .detalle-btn:hover {
            background: #548235;
        }
        .detalle-row {
            transition: all 0.3s;
        }
        .detalle-content {
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 2px 12px rgba(44,130,201,0.08);
            margin: 0.5rem 0;
        }
        @media (max-width: 900px) {
            .solicitudes-table-container { padding: 1rem 0.2rem; }
            .solicitudes-table th, .solicitudes-table td { font-size: 0.85rem; padding: 8px 4px; }
            .solicitudes-filtros input, .solicitudes-filtros select { min-width: 120px; }
        }
        @media (max-width: 600px) {
            .solicitudes-table-container { padding: 0.5rem 0; }
            .solicitudes-table th, .solicitudes-table td { font-size: 0.75rem; padding: 6px 2px; }
            .solicitudes-filtros { flex-direction: column; gap: 0.5rem; }
        }
        .detalle-nav-btn {
            background: #2f5597;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.4rem 1.2rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 0 0.5rem;
            transition: background 0.2s;
        }
        .detalle-nav-btn:disabled {
            background: #ccc;
            color: #888;
            cursor: not-allowed;
        }
        .detalle-nav-btn:hover:not(:disabled) {
            background: #548235;
        }
    </style>
</head>
<body>
    <div class="top-bars">
        <div class="top-bar-1"></div>
        <div class="top-bar-2"></div>
    </div>
    <img src="referencia.png" alt="Imagen de referencia" style="display: block; margin: 0 auto; margin-top: 10px;">
    <header>
        <div class="header-top">
            
            <img src="unidad-educativa-logo.png" alt="Logo de la Institución" class="logo">
            <div class="header-text">
                <h1>Unidad Educativa </h1>
                <h1>"Víctor Manuel Guzmán"</h1>
                <p>50 años de Educación Estudiantil</p>
            </div>
            <div class="auth-links">
                <!-- Los enlaces se gestionarán dinámicamente desde script.js -->
            </div>
            <nav>
                <ul class="menu">
                    <li><a href="index.html">Inicio</a></li>
                    <li class="dropdown">
                        <a href="#">Nosotros</a>
                        <ul class="submenu">
                            <li><a href="quienes-somos.html">Quiénes Somos</a></li>
                            <li><a href="autoridades.html">Autoridades</a></li>
                            <li><a href="historia.html">Historia</a></li>
                            <li><a href="ambientes.html">Sede y Ambientes</a></li>
                            <li><a href="simbolos.html">Símbolos Institucionales</a></li>
                            <li><a href="#oferta-educativa">Oferta Educativa</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Docentes</a>
                        <ul class="submenu">
                            <li><a href="calendario.html">Cronograma de Actividades</a></li>
                            <li><a href="sistemas-ministerio-educacion.html">Sistemas del Ministerio de Educación</a></li>
                            
                            <li><a href="#recursos">Recursos Didácticos</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Padres de Familia</a>
                        <ul class="submenu">
                            <li><a href="#comite-padres">Comité Central de Padres de Familia</a></li>
                            <li><a href="#horario-padres">Horario de Atención a Padres de Familia</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Estudiantes</a>
                        <ul class="submenu">
                            <li><a href="#consejo-estudiantil">Consejo Estudiantil</a></li>
                            <li><a href="#cuadro-honor">Cuadro de Honor</a></li>
                            <li><a href="#horario-clases">Horario de Clases</a></li>
                            <li><a href="#uniforme-escolar">Uniforme Escolar</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Servicios</a>
                        <ul class="submenu">
                            <li><a href="#aula-virtual">Aula Virtual Institucional</a></li>
                            <li><a href="#dece">DECE</a></li>
                           
                            
                            <li><a href="#bar-institucional">Bar Institucional</a></li>
                            <li><a href="#banda-musical">Banda Musical</a></li>
                            <li><a href="#biblioteca-virtual">Biblioteca Virtual</a></li>
                            
                            <li><a href="#bastoneras">Grupo de Bastoneras y Cachiporreros</a></li>
                        </ul>
                    </li>
                    <li><a href="ubicacion.html">Contactos</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main style="margin-top: 120px;">
        <div class="centered-section" style="background: #f8fafc; border-radius: 16px; box-shadow: 0 4px 24px rgba(44,130,201,0.10); padding: 2rem 0;">
            <h2 class="section-title" style="color:#2f5597;text-align:center;">Solicitudes de Matriculación</h2>
            <div class="solicitudes-tabs">
                <button id="btn-entrantes" class="solicitudes-tab-btn active">Solicitudes Entrantes</button>
                <button id="btn-verificadas" class="solicitudes-tab-btn">Solicitudes Verificadas</button>
            </div>
            <div class="solicitudes-filtros">
                <input type="text" id="filtro-cedula" placeholder="Buscar por cédula">
                <input type="text" id="filtro-nombres" placeholder="Buscar por nombres">
                <select id="filtro-curso" style="min-width:180px;">
                    <option value="">Curso/Grado</option>
                    <option value="Inicial">Inicial</option>
                    <option value="1ro EGB">1ro EGB</option>
                    <option value="2do EGB">2do EGB</option>
                    <option value="3ro EGB">3ro EGB</option>
                    <option value="4to EGB">4to EGB</option>
                    <option value="5to EGB">5to EGB</option>
                    <option value="6to EGB">6to EGB</option>
                    <option value="7mo EGB">7mo EGB</option>
                    <option value="8vo EGB">8vo EGB</option>
                    <option value="9no EGB">9no EGB</option>
                    <option value="10mo EGB">10mo EGB</option>
                    <option value="1ro Bachillerato">1ro Bachillerato</option>
                    <option value="2do Bachillerato">2do Bachillerato</option>
                    <option value="3ro Bachillerato">3ro Bachillerato</option>
                </select>
                <select id="filtro-paralelo" style="min-width:100px;">
                    <option value="">Paralelo</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                </select>
                <select id="filtro-especialidad" style="min-width:180px;">
                    <option value="">Especialidad</option>
                    <option value="Informática">Informática</option>
                    <option value="Contabilidad">Contabilidad</option>
                    <option value="Gestión Administrativa">Gestión Administrativa</option>
                    <option value="Ciencias">Ciencias</option>
                </select>
                <button id="btn-filtrar">Filtrar</button>
                <button id="btn-limpiar" style="background:#ccc;color:#222;">Limpiar</button>
            </div>
            <div class="solicitudes-table-container">
                <div id="tabla-solicitudes"></div>
            </div>
        </div>
    </main>
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>UNIDAD EDUCATIVA "VICTOR MANUEL GUZMAN"</h3>
                <div class="footer-line"></div>
                <p>Todos los contenidos digitales del portal web, se prohíbe su reproducción total, parcial y traducción a cualquier idioma sin autorización escrita por su titular.</p>
            </div>
            <div class="footer-section">
                <h3>ACCESOS DIRECTOS</h3>
                <div class="footer-line"></div>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="registro.html">Registro</a></li>
                    <li><a href="#autoridades">Autoridades</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>CONTACTOS</h3>
                <div class="footer-line"></div>
                <p>Av. El Retorno 5-130 y Av. Ricardo Sánchez, Ibarra, Ecuador</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Unidad Educativa Victor Manuel Guzmán © Copyrights 2025 Realizado por Dominick López, Juan Alba y Hugo Castillo
                +-
            </p>
        </div>
    </footer>
    <script>
        const usuarioActivo = localStorage.getItem('usuarioActivo');
        if (!usuarioActivo) {
            alert('Debe iniciar sesión para acceder.');
            window.location.href = 'login.html';
        }
        async function verificarRol() {
            const supabase = window.supabase.createClient(
                "https://zeijayrxciyzymysbyvp.supabase.co",
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplaWpheXJ4Y2l5enlteXNieXZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNjYyMjMsImV4cCI6MjA1OTc0MjIyM30.DxT8_5acA88JxhVV7n2UqmrZ_9d0DPABi6eKSO8cpDE"
            );
            const { data, error } = await supabase
                .from('usuarios')
                .select('rol')
                .eq('email', usuarioActivo);
            if (!data || !data[0] || (data[0].rol !== 'admin' && data[0].rol !== 'administrador')) {
                alert('Acceso restringido solo para administradores.');
                window.location.href = 'index.html';
            }
        }
        verificarRol();

        const supabase = window.supabase.createClient(
            "https://zeijayrxciyzymysbyvp.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplaWpheXJ4Y2l5enlteXNieXZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNjYyMjMsImV4cCI6MjA1OTc0MjIyM30.DxT8_5acA88JxhVV7n2UqmrZ_9d0DPABi6eKSO8cpDE"
        );

        let estadoActual = 'entrante';

        document.getElementById('btn-entrantes').onclick = () => {
            estadoActual = 'entrante';
            document.getElementById('btn-entrantes').classList.add('active');
            document.getElementById('btn-verificadas').classList.remove('active');
            cargarSolicitudes();
        };
        document.getElementById('btn-verificadas').onclick = () => {
            estadoActual = 'verificada';
            document.getElementById('btn-verificadas').classList.add('active');
            document.getElementById('btn-entrantes').classList.remove('active');
            cargarSolicitudes();
        };
        document.getElementById('btn-filtrar').onclick = cargarSolicitudes;
        document.getElementById('btn-limpiar').onclick = () => {
            document.getElementById('filtro-cedula').value = '';
            document.getElementById('filtro-nombres').value = '';
            document.getElementById('filtro-curso').value = '';
            document.getElementById('filtro-paralelo').value = '';
            document.getElementById('filtro-especialidad').value = '';
            cargarSolicitudes();
        };

        let detalleAbierto = null;

        async function mostrarDetalle(id, s) {
            const cont = document.getElementById('detalle-content-' + id);
            cont.innerHTML = '<span style="color:#888;">Cargando detalles...</span>';
            let est = s.estudiante;
            const insc = s.inscripcion;
            const curso = s.curso;
            let direccion = null;
            let padre = null;
            let madre = null;
            let representante = null;
            let contactos = [];
            let mapaHtml = '';

            // NUEVO: Obtener datos completos del estudiante por id_cedula
            let datosExtraEstudiante = {};
            let institucionProcedencia = "";
            try {
                // Buscar id_cedula
                let idCedula = est.id_cedula;
                if (!idCedula && s.cedula) {
                    const { data: cedulaRow } = await supabase
                        .from('cedulas')
                        .select('id_cedula')
                        .eq('cedula', s.cedula)
                        .single();
                    if (cedulaRow) idCedula = cedulaRow.id_cedula;
                }
                if (idCedula) {
                    // Buscar estudiante por id_cedula
                    const { data: estRow } = await supabase
                        .from('estudiante')
                        .select('etnia, nacionalidad, tipo_sangre, fecha_nacimiento, sexo, telefono, telefono_convencional')
                        .eq('id_cedula', idCedula)
                        .order('id_estudiante', { ascending: false })
                        .limit(1)
                        .maybeSingle();
                    if (estRow) datosExtraEstudiante = estRow;
                }
                // Buscar institucion_procedencia desde solicitud_inscripcion
                if (est.id_inscripcion) {
                    const { data: inscRow } = await supabase
                        .from('solicitud_inscripcion')
                        .select('institucion_procedencia')
                        .eq('id', est.id_inscripcion)
                        .maybeSingle();
                    if (inscRow && inscRow.institucion_procedencia) {
                        institucionProcedencia = inscRow.institucion_procedencia;
                    }
                } else if (insc && insc.institucion_procedencia) {
                    institucionProcedencia = insc.institucion_procedencia;
                }
            } catch {}

            est = {
                ...est,
                ...datosExtraEstudiante
            };

            try {
                // Dirección
                const { data: dirs } = await supabase
                    .from('direccion_estudiante')
                    .select('*')
                    .eq('id_estudiante', est.id_estudiante);
                if (dirs && dirs.length > 0) {
                    direccion = dirs[0];
                    if (direccion.latitud && direccion.longitud) {
                        const lat = direccion.latitud, lng = direccion.longitud;
                        const mapaUrl = `https://maps.google.com/maps?q=${lat},${lng}&z=17&output=embed`;
                        mapaHtml = `<iframe width="350" height="180" style="border-radius:8px;border:1px solid #ccc;" src="${mapaUrl}" allowfullscreen="" loading="lazy"></iframe>`;
                    }
                }
                // Padre
                const { data: padres } = await supabase
                    .from('padre_estudiante')
                    .select('*')
                    .eq('id_estudiante', est.id_estudiante);
                if (padres && padres.length > 0) padre = padres[0];
                // Madre
                const { data: madres } = await supabase
                    .from('madre_estudiante')
                    .select('*')
                    .eq('id_estudiante', est.id_estudiante);
                if (madres && madres.length > 0) madre = madres[0];
                // Representante
                const { data: reps } = await supabase
                    .from('representante_estudiante')
                    .select('*')
                    .eq('id_estudiante', est.id_estudiante);
                if (reps && reps.length > 0) representante = reps[0];
                // Contactos de emergencia
                const { data: conts } = await supabase
                    .from('contacto_emergencia_estudiante')
                    .select('*')
                    .eq('id_estudiante', est.id_estudiante);
                if (conts && conts.length > 0) contactos = conts;
            } catch {}

            let pdfHtml = s.pdf_url ? `<a class="pdf-link" href="${s.pdf_url}" target="_blank" download>Descargar PDF</a>` : '<span style="color:#888;">PDF no disponible</span>';

            // Panel de pasos
            const pasos = [
                {
                    titulo: "Datos Académicos",
                    html: `
                        <table style="width:100%;font-size:1rem;">
                            <tr><td><b>Periodo:</b></td><td>${insc.periodo || ''}</td></tr>
                            <tr><td><b>Curso:</b></td><td>${curso.nombre_curso || ''} - ${insc.paralelo || ''}</td></tr>
                            <tr><td><b>Especialidad:</b></td><td>${insc.especialidad || ''}</td></tr>
                            <tr><td><b>Institución Procedencia:</b></td><td>${institucionProcedencia || ''}</td></tr>
                        </table>
                    `
                },
                {
                    titulo: "Datos del Estudiante",
                    html: `
                        <table style="width:100%;font-size:1rem;">
                            <tr><td><b>Apellidos:</b></td><td>${est.apellidos||''}</td></tr>
                            <tr><td><b>Nombres:</b></td><td>${est.nombres||''}</td></tr>
                            <tr><td><b>Cédula:</b></td><td>${s.cedula||''}</td></tr>
                            <tr><td><b>Correo:</b></td><td>${est.correo||''}</td></tr>
                            <tr><td><b>Etnia:</b></td><td>${est.etnia||''}</td></tr>
                            <tr><td><b>Nacionalidad:</b></td><td>${est.nacionalidad||''}</td></tr>
                            <tr><td><b>Tipo de Sangre:</b></td><td>${est.tipo_sangre||''}</td></tr>
                            <tr><td><b>Fecha de Nacimiento:</b></td><td>${est.fecha_nacimiento||''}</td></tr>
                            <tr><td><b>Sexo:</b></td><td>${est.sexo||''}</td></tr>
                            <tr><td><b>Teléfono:</b></td><td>${est.telefono||''}</td></tr>
                            <tr><td><b>Teléfono Convencional:</b></td><td>${est.telefono_convencional||''}</td></tr>
                        </table>
                    `
                },
                {
                    titulo: "Dirección de Vivienda",
                    html: direccion ? `
                        <table style="width:100%;font-size:1rem;">
                            <tr><td><b>Calle Principal:</b></td><td>${direccion.calle_principal||''}</td></tr>
                            <tr><td><b>Calle Secundaria:</b></td><td>${direccion.calle_secundaria||''}</td></tr>
                            <tr><td><b>Provincia:</b></td><td>${direccion.provincia||''}</td></tr>
                            <tr><td><b>Cantón:</b></td><td>${direccion.canton||''}</td></tr>
                            <tr><td><b>Parroquia:</b></td><td>${direccion.parroquia||''}</td></tr>
                            <tr><td><b>Barrio:</b></td><td>${direccion.barrio||''}</td></tr>
                            <tr><td><b>Número de Casa:</b></td><td>${direccion.numero_casa||''}</td></tr>
                            <tr><td><b>Referencia:</b></td><td>${direccion.referencia||''}</td></tr>
                        </table>
                        <div style="margin-top:0.7rem;">
                            <b>Ubicación:</b><br>
                            ${mapaHtml || '<span style="color:#888;">No disponible</span>'}
                        </div>
                    ` : '<span style="color:#888;">No disponible</span>'
                },
                {
                    titulo: "Datos del Padre",
                    html: padre ? `
                        <table style="width:100%;font-size:1rem;">
                            <tr><td><b>Nombre:</b></td><td>${padre.nombres||''}</td></tr>
                            <tr><td><b>Cédula:</b></td><td>${padre.cedula||''}</td></tr>
                            <tr><td><b>Ocupación:</b></td><td>${padre.ocupacion||''}</td></tr>
                            <tr><td><b>Email:</b></td><td>${padre.email||''}</td></tr>
                            <tr><td><b>Teléfono:</b></td><td>${padre.telefono_celular||''}</td></tr>
                        </table>
                    ` : '<span style="color:#888;">No disponible</span>'
                },
                {
                    titulo: "Datos de la Madre",
                    html: madre ? `
                        <table style="width:100%;font-size:1rem;">
                            <tr><td><b>Nombre:</b></td><td>${madre.nombres||''}</td></tr>
                            <tr><td><b>Cédula:</b></td><td>${madre.cedula||''}</td></tr>
                            <tr><td><b>Ocupación:</b></td><td>${madre.ocupacion||''}</td></tr>
                            <tr><td><b>Email:</b></td><td>${madre.email||''}</td></tr>
                            <tr><td><b>Teléfono:</b></td><td>${madre.telefono_celular||''}</td></tr>
                        </table>
                    ` : '<span style="color:#888;">No disponible</span>'
                },
                {
                    titulo: "Datos del Representante",
                    html: representante ? `
                        <table style="width:100%;font-size:1rem;">
                            <tr><td><b>Nombre:</b></td><td>${representante.nombres||''}</td></tr>
                            <tr><td><b>Cédula:</b></td><td>${representante.cedula||''}</td></tr>
                            <tr><td><b>Ocupación:</b></td><td>${representante.ocupacion||''}</td></tr>
                            <tr><td><b>Email:</b></td><td>${representante.email||''}</td></tr>
                            <tr><td><b>Teléfono:</b></td><td>${representante.telefono_celular||''}</td></tr>
                        </table>
                    ` : '<span style="color:#888;">No disponible</span>'
                },
                {
                    titulo: "Datos Educativos y Emergencia",
                    html: `
                        <div style="margin-bottom:1rem;">${pdfHtml}</div>
                        <div>
                            <b>Contactos de Emergencia:</b>
                            <ul>
                                ${contactos.length > 0 ? contactos.map(c => `<li>${c.nombre} (${c.parentesco}) - ${c.telefono}</li>`).join('') : '<li>No disponible</li>'}
                            </ul>
                        </div>
                    `
                }
            ];

            if (!window._detallePaso) window._detallePaso = {};
            if (typeof window._detallePaso[id] !== "number") window._detallePaso[id] = 0;
            function renderPaso() {
                let paso = pasos[window._detallePaso[id]];
                cont.innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <button type="button" class="detalle-nav-btn" id="detalle-prev-${id}" ${window._detallePaso[id] === 0 ? 'disabled' : ''}>&#8592; Volver</button>
                        <h3 style="color:#2f5597;text-align:center;flex:1;">${paso.titulo}</h3>
                        <button type="button" class="detalle-nav-btn" id="detalle-next-${id}" ${window._detallePaso[id] === pasos.length-1 ? 'disabled' : ''}>Siguiente &#8594;</button>
                    </div>
                    <div style="margin-top:1.2rem;">${paso.html}</div>
                `;
                setTimeout(() => {
                    const prevBtn = document.getElementById(`detalle-prev-${id}`);
                    const nextBtn = document.getElementById(`detalle-next-${id}`);
                    if (prevBtn) {
                        prevBtn.addEventListener('click', function() {
                            if (window._detallePaso[id] > 0) {
                                window._detallePaso[id] = window._detallePaso[id] - 1;
                                renderPaso();
                            }
                        });
                    }
                    if (nextBtn) {
                        nextBtn.addEventListener('click', function() {
                            if (window._detallePaso[id] < pasos.length - 1) {
                                window._detallePaso[id] = window._detallePaso[id] + 1;
                                renderPaso();
                            }
                        });
                    }
                }, 0);
            }
            renderPaso();
        }

        window.toggleDetalle = async function(id) {
            if (detalleAbierto && detalleAbierto !== id) {
                document.getElementById('detalle-row-' + detalleAbierto).style.display = 'none';
            }
            const row = document.getElementById('detalle-row-' + id);
            if (row.style.display === 'none') {
                row.style.display = '';
                detalleAbierto = id;
                let s = null;
                if (window._ultimasSolicitudes) {
                    s = window._ultimasSolicitudes.find(x => x.id === id);
                }
                if (!s) {
                    await cargarSolicitudes();
                    s = window._ultimasSolicitudes.find(x => x.id === id);
                }
                if (s) await mostrarDetalle(id, s);
            } else {
                row.style.display = 'none';
                detalleAbierto = null;
            }
        };

        async function cargarSolicitudes() {
            const cedula = document.getElementById('filtro-cedula').value.trim();
            const nombres = document.getElementById('filtro-nombres').value.trim();
            const curso = document.getElementById('filtro-curso').value;
            const paralelo = document.getElementById('filtro-paralelo').value;
            const especialidad = document.getElementById('filtro-especialidad').value;

            let { data: solicitudes, error } = await supabase
                .from('solicitud_matriculacion')
                .select('id, estado, pdf_url, fecha_creacion, fecha_verificacion, verificado_por, id_estudiante')
                .eq('estado', estadoActual)
                .order('fecha_creacion', { ascending: false });

            if (error) {
                document.getElementById('tabla-solicitudes').innerHTML = `<p style="color:red;">Error al cargar solicitudes: ${error.message}</p>`;
                return;
            }
            if (!solicitudes || solicitudes.length === 0) {
                document.getElementById('tabla-solicitudes').innerHTML = `<p style="text-align:center;">No hay solicitudes en este estado.</p>`;
                return;
            }

            const idsEstudiantes = solicitudes.map(s => s.id_estudiante).filter(Boolean);
            let estudiantes = [];
            if (idsEstudiantes.length > 0) {
                const { data: ests, error: errEst } = await supabase
                    .from('estudiante')
                    .select('id_estudiante, apellidos, nombres, id_cedula, correo, archivo_url, id_inscripcion')
                    .in('id_estudiante', idsEstudiantes);
                if (!errEst && ests) estudiantes = ests;
            }

            const idsCedulas = estudiantes.map(e => e.id_cedula).filter(Boolean);
            let cedulas = [];
            if (idsCedulas.length > 0) {
                const { data: cedulasData, error: errCed } = await supabase
                    .from('cedulas')
                    .select('id_cedula, cedula')
                    .in('id_cedula', idsCedulas);
                if (!errCed && cedulasData) cedulas = cedulasData;
            }

            const idsInscripciones = estudiantes.map(e => e.id_inscripcion).filter(Boolean);
            let inscripciones = [];
            if (idsInscripciones.length > 0) {
                const { data: inscs, error: errIns } = await supabase
                    .from('solicitud_inscripcion')
                    .select('id, id_curso, especialidad, paralelo, periodo')
                    .in('id', idsInscripciones);
                if (!errIns && inscs) inscripciones = inscs;
            }

            const idsCursos = inscripciones.map(i => i.id_curso).filter(Boolean);
            let cursos = [];
            if (idsCursos.length > 0) {
                const { data: cursosData, error: errCursos } = await supabase
                    .from('curso_nivel')
                    .select('id_curso, nombre_curso')
                    .in('id_curso', idsCursos);
                if (!errCursos && cursosData) cursos = cursosData;
            }

            function getEstudiante(id) {
                return estudiantes.find(e => e.id_estudiante === id) || {};
            }
            function getCedula(id_cedula) {
                return cedulas.find(c => c.id_cedula === id_cedula)?.cedula || '';
            }
            function getInscripcion(id) {
                return inscripciones.find(i => i.id === id) || {};
            }
            function getCurso(id_curso) {
                return cursos.find(c => c.id_curso === id_curso) || {};
            }

            let filtradas = solicitudes.map(s => {
                const est = getEstudiante(s.id_estudiante);
                const cedulaEst = getCedula(est.id_cedula);
                const insc = getInscripcion(est.id_inscripcion);
                const cursoObj = getCurso(insc.id_curso);
                return {
                    ...s,
                    estudiante: est,
                    cedula: cedulaEst,
                    inscripcion: insc,
                    curso: cursoObj
                };
            }).filter(s => {
                let ok = true;
                if (cedula && !(s.cedula || '').toString().toLowerCase().includes(cedula.toLowerCase())) ok = false;
                if (nombres && !(s.estudiante.nombres || '').toLowerCase().includes(nombres.toLowerCase())) ok = false;
                if (curso && (s.curso.nombre_curso !== curso)) ok = false;
                if (paralelo && (s.inscripcion.paralelo !== paralelo)) ok = false;
                if (especialidad && (s.inscripcion.especialidad !== especialidad)) ok = false;
                return ok;
            });

            window._ultimasSolicitudes = filtradas;

            if (filtradas.length === 0) {
                document.getElementById('tabla-solicitudes').innerHTML = `<p style="text-align:center;">No hay solicitudes que coincidan con los filtros.</p>`;
                return;
            }

            let html = `<table class="solicitudes-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Apellidos</th>
                        <th>Nombres</th>
                        <th>Cédula</th>
                        <th>Curso</th>
                        <th>Especialidad</th>
                        <th>Correo</th>
                        <th>PDF</th>
                        <th>Acción</th>
                        <th>Eliminar solicitud</th>
                        <th>Detalles</th>
                    </tr>
                </thead>
                <tbody>`;
            for (const s of filtradas) {
                html += `<tr>
                    <td>${(s.fecha_creacion || '').substring(0, 10)}</td>
                    <td>${s.estudiante.apellidos || ''}</td>
                    <td>${s.estudiante.nombres || ''}</td>
                    <td>${s.cedula || ''}</td>
                    <td>${s.curso.nombre_curso || ''}</td>
                    <td>${s.inscripcion.especialidad || ''}</td>
                    <td>${s.estudiante.correo || ''}</td>
                    <td>${s.pdf_url ? `<a class="pdf-link" href="${s.pdf_url}" target="_blank">Ver PDF</a>` : 'No disponible'}</td>
                    <td>
                        ${estadoActual === 'entrante'
                            ? `<button class="verificar-btn" onclick="verificarSolicitud(${s.id})">Verificar</button>`
                            : (s.verificado_por ? `<span class="estado-label">Verificado por ${s.verificado_por}</span>` : '<span class="estado-label">Verificado</span>')}
                    </td>
                    <td>
                        <button class="eliminar-btn" onclick="eliminarSolicitud(${s.id})">Eliminar</button>
                    </td>
                    <td>
                        <button class="detalle-btn" onclick="toggleDetalle(${s.id})" title="Ver detalles">&#9654;</button>
                    </td>
                </tr>
                <tr id="detalle-row-${s.id}" class="detalle-row" style="display:none;">
                    <td colspan="12" style="background:#f8fafc;">
                        <div id="detalle-content-${s.id}" class="detalle-content" style="padding:1.5rem 1rem;">
                            <span style="color:#888;">Cargando detalles...</span>
                        </div>
                    </td>
                </tr>`;
            }
            html += `</tbody></table>`;
            document.getElementById('tabla-solicitudes').innerHTML = html;
        }

        window.verificarSolicitud = async function(id) {
            const confirmar = confirm('¿Está seguro de verificar esta solicitud?');
            if (!confirmar) return;

            // 1. Obtener datos del estudiante para crear usuario
            let estudiante = null;
            let cedula = null;
            let fechaNacimiento = null;
            try {
                // Buscar la solicitud
                const { data: solicitud } = await supabase
                    .from('solicitud_matriculacion')
                    .select('id_estudiante')
                    .eq('id', id)
                    .maybeSingle();
                if (solicitud && solicitud.id_estudiante) {
                    // Buscar estudiante
                    const { data: est } = await supabase
                        .from('estudiante')
                        .select('id_estudiante, id_cedula, fecha_nacimiento, apellidos, nombres')
                        .eq('id_estudiante', solicitud.id_estudiante)
                        .maybeSingle();
                    if (est) {
                        estudiante = est;
                        // Buscar cédula
                        if (est.id_cedula) {
                            const { data: ced } = await supabase
                                .from('cedulas')
                                .select('cedula')
                                .eq('id_cedula', est.id_cedula)
                                .maybeSingle();
                            if (ced) cedula = ced.cedula;
                        }
                        fechaNacimiento = est.fecha_nacimiento;
                    }
                }
            } catch (e) {}

            // 2. Crear usuario si no existe y si hay cédula y fecha de nacimiento
            let usuarioCreado = false;
            if (cedula && fechaNacimiento) {
                // Formato de contraseña: fechaNacimiento sin guiones ni slash
                const pass = fechaNacimiento.replace(/[-\/]/g, '');
                // Verificar si ya existe el usuario
                const { data: existe } = await supabase
                    .from('usuarios')
                    .select('id')
                    .eq('email', cedula)
                    .maybeSingle();
                if (!existe) {
                    // Insertar usuario con rol "estudiante"
                    await supabase
                        .from('usuarios')
                        .insert([{
                            usuario: estudiante ? (estudiante.nombres + ' ' + estudiante.apellidos) : cedula,
                            email: cedula,
                            password: pass,
                            rol: 'estudiante'
                        }]);
                    usuarioCreado = true;
                }
            }

            // 3. Actualizar estado de la solicitud
            const { error } = await supabase
                .from('solicitud_matriculacion')
                .update({
                    estado: 'verificada',
                    fecha_verificacion: new Date().toISOString(),
                    verificado_por: usuarioActivo
                })
                .eq('id', id);
            if (error) {
                alert('Error al verificar: ' + error.message);
            } else {
                let msg = 'Solicitud verificada correctamente.';
                if (usuarioCreado) {
                    msg += `\nUsuario creado:\nUsuario: ${cedula}\nContraseña: ${fechaNacimiento ? fechaNacimiento.replace(/[-\/]/g, '') : ''}`;
                }
                alert(msg);
                cargarSolicitudes();
            }
        };

        window.eliminarSolicitud = async function(id) {
            if (!confirm('¿Está seguro de eliminar esta solicitud? Esta acción no se puede deshacer.')) return;
            const { error } = await supabase
                .from('solicitud_matriculacion')
                .delete()
                .eq('id', id);
            if (error) {
                alert('Error al eliminar: ' + error.message);
            } else {
                alert('Solicitud eliminada correctamente.');
                cargarSolicitudes();
            }
        };

        cargarSolicitudes();
    </script>
    <script src="script.js" defer></script>
</body>
</html>
